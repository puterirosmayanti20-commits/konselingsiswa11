import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged,
  signInWithCustomToken,
  createUserWithEmailAndPassword, // Baru
  signInWithEmailAndPassword,     // Baru 
  signOut                         // Baru
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  doc, 
  addDoc, 
  setDoc, 
  getDoc,
  onSnapshot, 
  query, 
  where,
  updateDoc
} from 'firebase/firestore';
import { 
  Users, 
  Calendar, 
  BookOpen, 
  Clock, 
  Check, 
  Plus, 
  LogOut, 
  MessageSquare,
  Home,
  FileText,
  LogIn,    // Baru
  UserPlus  // Baru
} from 'lucide-react';

// --- KONFIGURASI FIREBASE ---
// Variabel ini akan disediakan oleh lingkungan Canvas secara otomatis.
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// Inisialisasi Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Path database (menggunakan path publik agar siswa & konselor bisa saling menemukan)
const publicPath = `artifacts/${appId}/public/data`;
const counselorsCol = collection(db, `${publicPath}/counselors`);
const appointmentsCol = collection(db, `${publicPath}/appointments`);
const resourcesCol = collection(db, `${publicPath}/resources`);
const usersCol = collection(db, `${publicPath}/users`); // Koleksi baru untuk profil pengguna

// --- DATA KONSTAN UNTUK REGISTRASI ---
const grades = [10, 11, 12];
const classes = 'ABCDEFGHIJKL'.split('');
const classList = grades.flatMap(g => classes.map(c => `${g}${c}`));
const specialties = ['Akademik', 'Karir', 'Keluarga', 'Pribadi', 'Sosial'];


// --- KOMPONEN UTAMA (APP) ---
export default function App() {
  const [user, setUser] = useState(null);
  // const [role, setRole] = useState(null); // Diganti dengan userProfile
  const [userProfile, setUserProfile] = useState(null); // State baru untuk data user dari Firestore
  const [isLoading, setIsLoading] = useState(true); // Loading untuk auth
  const [isLoadingProfile, setIsLoadingProfile] = useState(true); // Loading untuk profil Firestore

  // Efek untuk menangani status autentikasi (login/logout)
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      setIsLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // Efek untuk mengambil profil pengguna dari Firestore saat user login
  useEffect(() => {
    if (user) {
      setIsLoadingProfile(true);
      const userRef = doc(db, `${publicPath}/users`, user.uid);
      const unsubscribe = onSnapshot(userRef, (docSnap) => {
        if (docSnap.exists()) {
          setUserProfile(docSnap.data());
        } else {
          setUserProfile(null); // User diautentikasi tapi profil tidak ada
        }
        setIsLoadingProfile(false);
      });
      return () => unsubscribe();
    } else {
      setUserProfile(null);
      setIsLoadingProfile(false);
    }
  }, [user]);


  // Fungsi untuk logout
  const handleLogout = async () => {
    try {
      await signOut(auth);
      // setUser(null) dan setUserProfile(null) akan di-handle oleh listener
    } catch (error) {
      console.error("Gagal logout:", error);
    }
  };

  // Render berdasarkan status
  if (isLoading || isLoadingProfile) {
    return <LoadingScreen />;
  }

  if (!user || !userProfile) {
    // Jika user tidak login, atau login tapi tidak punya profil, tampilkan AuthScreen
    return <AuthScreen />;
  }
  
  const role = userProfile.role; // Ambil role dari profil

  return (
    <div className="min-h-screen bg-gray-50 font-inter">
      <Navbar role={role} onLogout={handleLogout} userProfile={userProfile} />
      <main className="p-4 md:p-8 max-w-6xl mx-auto">
        {role === 'student' && <StudentDashboard user={user} userProfile={userProfile} />}
        {role === 'counselor' && <CounselorDashboard user={user} userProfile={userProfile} />}
      </main>
    </div>
  );
}

// --- KOMPONEN NAVIGASI ---
function Navbar({ role, onLogout, userProfile }) {
  return (
    <nav className="bg-white shadow-sm w-full">
      <div className="max-w-6xl mx-auto px-4 md:px-8">
        <div className="flex justify-between items-center h-16">
          <div className="flex items-center space-x-3">
            <div className="bg-blue-600 p-2 rounded-lg">
              <MessageSquare className="text-white" size={20} />
            </div>
            <span className="font-bold text-xl text-gray-800">Ruang Konseling</span>
          </div>
          <div className="flex items-center space-x-4">
            <span className="text-sm text-gray-600 hidden md:block">
              Halo, <span className="font-semibold capitalize text-blue-600">{userProfile.name}</span> ({role})
            </span>
            <button
              onClick={onLogout}
              className="flex items-center space-x-2 text-sm text-gray-700 hover:text-red-600 transition-colors"
              title="Ganti Peran"
            >
              <LogOut size={16} />
              <span className="hidden md:block">Ganti Peran</span>
            </button>
          </div>
        </div>
      </div>
    </nav>
  );
}

// --- KOMPONEN LAYAR PEMILIHAN PERAN (DIGANTI) ---
// RoleSelectionScreen dihapus dan diganti dengan AuthScreen

// --- KOMPONEN BARU: LAYAR AUTENTIKASI (LOGIN & REGISTRASI) ---
function AuthScreen() {
  const [isLogin, setIsLogin] = useState(true); // Ganti antara mode Login / Register

  // State untuk form
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [name, setName] = useState("");
  const [role, setRole] = useState("student");
  const [studentClass, setStudentClass] = useState(classList[0]); // Default ke 10A
  const [specialty, setSpecialty] = useState(specialties[0]); // Default ke Akademik

  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState("");

  // Fungsi untuk menangani Login
  const handleLogin = async (e) => {
    e.preventDefault();
    if (!email || !password) {
      setError("Email dan password harus diisi.");
      return;
    }
    setIsLoading(true);
    setError("");
    try {
      await signInWithEmailAndPassword(auth, email, password);
      // onAuthStateChanged di App akan menangani sisanya
    } catch (err) {
      setError("Gagal login. Periksa kembali email dan password Anda.");
      console.error("Kesalahan login:", err);
    }
    setIsLoading(false);
  };

  // Fungsi untuk menangani Registrasi
  const handleRegister = async (e) => {
    e.preventDefault();
    if (!email || !password || !name) {
      setError("Email, password, dan nama harus diisi.");
      return;
    }
    setIsLoading(true);
    setError("");
    try {
      // 1. Buat user di Firebase Auth
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;

      // 2. Siapkan data profil untuk Firestore
      const profileData = {
        uid: user.uid,
        email: user.email,
        name: name,
        role: role,
      };
      
      if (role === 'student') {
        profileData.class = studentClass;
      } else {
        profileData.specialty = specialty;
      }

      // 3. Simpan profil ke Firestore
      const userRef = doc(db, `${publicPath}/users`, user.uid);
      await setDoc(userRef, profileData);

      // Login terjadi otomatis setelah registrasi
      // onAuthStateChanged di App akan menangani sisanya

    } catch (err) {
      setError("Gagal mendaftar. " + err.message);
      console.error("Kesalahan registrasi:", err);
    }
    setIsLoading(false);
  };
  
  return (
    <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-50 via-white to-indigo-50">
      <div className="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-xl">
        <h2 className="text-3xl font-bold text-gray-800 text-center">
          {isLogin ? "Login Akun" : "Registrasi Akun Baru"}
        </h2>
        
        {/* Form Utama */}
        <form onSubmit={isLogin ? handleLogin : handleRegister} className="space-y-4">
          {/* Input Email */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
            <input
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              placeholder="nama@sekolah.com"
              className="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
          </div>
          
          {/* Input Password */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              placeholder="••••••••"
              className="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
          </div>

          {/* ----- Field Khusus Registrasi ----- */}
          {!isLogin && (
            <>
              {/* Input Nama */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                <input
                  type="text"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  placeholder="Nama Lengkap Anda"
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                  required
                />
              </div>
              
              {/* Input Peran */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Saya adalah</label>
                <select
                  value={role}
                  onChange={(e) => setRole(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="student">Siswa</option>
                  <option value="counselor">Konselor (Guru BK)</option>
                </select>
              </div>

              {/* Input Kondisional (Kelas / Spesialisasi) */}
              {role === 'student' ? (
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                  <select
                    value={studentClass}
                    onChange={(e) => setStudentClass(e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    {classList.map(cls => (
                      <option key={cls} value={cls}>{cls}</option>
                    ))}
                  </select>
                </div>
              ) : (
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Spesialisasi</label>
                  <select
                    value={specialty}
                    onChange={(e) => setSpecialty(e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    {specialties.map(sp => (
                      <option key={sp} value={sp}>{sp}</option>
                    ))}
                  </select>
                </div>
              )}
            </>
          )}
          {/* --------------------------------- */}
          
          {error && (
            <p className="text-sm text-red-600 text-center">{error}</p>
          )}

          {/* Tombol Submit */}
          <button
            type="submit"
            disabled={isLoading}
            className="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-all duration-300 disabled:bg-gray-400"
          >
            {isLoading ? "Memproses..." : (isLogin ? "Login" : "Daftar")}
          </button>
        </form>
        
        {/* Tombol Ganti Mode */}
        <button
          onClick={() => {
            setIsLogin(!isLogin);
            setError("");
          }}
          className="w-full py-2 px-4 text-sm text-gray-600 hover:text-blue-600 font-medium"
        >
          {isLogin ? "Belum punya akun? Daftar di sini" : "Sudah punya akun? Login"}
        </button>
      </div>
    </div>
  );
}


// --- KOMPONEN DASHBOARD SISWA ---
function StudentDashboard({ user, userProfile }) {
  const [view, setView] = useState('home'); // 'home', 'counselors', 'appointments', 'resources'
  const [counselors, setCounselors] = useState([]);
  const [appointments, setAppointments] = useState([]);
  const [resources, setResources] = useState([]);
  const [selectedCounselor, setSelectedCounselor] = useState(null);
  const [isModalOpen, setIsModalOpen] = useState(false);

  // Ambil data konselor
  useEffect(() => {
    const unsubscribe = onSnapshot(counselorsCol, (snapshot) => {
      setCounselors(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
    });
    return () => unsubscribe();
  }, []);

  // Ambil data janji temu milik siswa ini
  useEffect(() => {
    const q = query(appointmentsCol, where("studentId", "==", user.uid));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const apts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      // Sortir client-side
      apts.sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));
      setAppointments(apts);
    });
    return () => unsubscribe();
  }, [user.uid]);

  // Ambil data materi
  useEffect(() => {
    const unsubscribe = onSnapshot(resourcesCol, (snapshot) => {
      setResources(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
    });
    return () => unsubscribe();
  }, []);

  const openBookingModal = (counselor) => {
    setSelectedCounselor(counselor);
    setIsModalOpen(true);
  };

  const closeBookingModal = () => {
    setIsModalOpen(false);
    setSelectedCounselor(null);
  };
  
  const upcomingAppointments = appointments.filter(apt => new Date(apt.dateTime) > new Date() && apt.status === 'approved');
  const pendingAppointments = appointments.filter(apt => apt.status === 'pending');

  return (
    <div className="flex flex-col md:flex-row gap-8">
      {/* Navigasi Samping */}
      <StudentSidebar view={view} setView={setView} />
      
      {/* Konten Utama */}
      <div className="flex-1">
        {view === 'home' && (
          <StudentHome 
            upcomingAppointments={upcomingAppointments} 
            pendingAppointments={pendingAppointments} 
            resources={resources}
            setView={setView}
            name={userProfile.name} // Kirim nama user
          />
        )}
        {view === 'counselors' && (
          <CounselorList 
            counselors={counselors} 
            onBook={openBookingModal} 
          />
        )}
        {view === 'appointments' && (
          <AppointmentList 
            title="Riwayat Janji Temu Saya"
            appointments={appointments} 
          />
        )}
        {view === 'resources' && (
          <ResourceList 
            title="Materi & Sumber Daya"
            resources={resources} 
          />
        )}
      </div>

      {isModalOpen && (
        <BookingModal
          user={user}
          counselor={selectedCounselor}
          onClose={closeBookingModal}
          userProfile={userProfile} // Kirim profil user
        />
      )}
    </div>
  );
}

function StudentHome({ upcomingAppointments, pendingAppointments, resources, setView, name }) {
  return (
    <div className="space-y-8">
      <h2 className="text-3xl font-bold text-gray-800 mb-6">Halo, {name}!</h2>

      {/* Janji Temu Mendatang */}
      <div className="bg-white p-6 rounded-lg shadow-md">
        <h3 className="text-xl font-semibold text-gray-800 mb-4">Janji Temu Mendatang</h3>
        {upcomingAppointments.length > 0 ? (
          <ul className="space-y-4">
            {upcomingAppointments.slice(0, 3).map(apt => (
              <li key={apt.id} className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <p className="font-semibold text-blue-800">{apt.counselorName}</p>
                <p className="text-sm text-gray-600">{new Date(apt.dateTime).toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'short' })}</p>
                <p className="text-sm text-gray-500 mt-1">Topik: {apt.topic}</p>
              </li>
            ))}
          </ul>
        ) : (
          <p className="text-gray-500">Tidak ada janji temu mendatang.</p>
        )}
        <button onClick={() => setView('appointments')} className="text-blue-600 font-medium text-sm mt-4 hover:underline">Lihat Semua</button>
      </div>
      
      {/* Janji Temu Pending */}
      {pendingAppointments.length > 0 && (
         <div className="bg-white p-6 rounded-lg shadow-md">
          <h3 className="text-xl font-semibold text-gray-800 mb-4">Menunggu Konfirmasi</h3>
          <ul className="space-y-3">
            {pendingAppointments.map(apt => (
              <li key={apt.id} className="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <p className="font-semibold text-yellow-800">{apt.counselorName}</p>
                <p className="text-sm text-gray-600">Diajukan: {new Date(apt.createdAt).toLocaleString('id-ID', { dateStyle: 'medium' })}</p>
              </li>
            ))}
          </ul>
        </div>
      )}

      {/* Sumber Daya Terbaru */}
      <div className="bg-white p-6 rounded-lg shadow-md">
        <h3 className="text-xl font-semibold text-gray-800 mb-4">Materi Terbaru</h3>
        {resources.length > 0 ? (
          <ul className="space-y-3">
            {resources.slice(0, 3).map(res => (
              <li key={res.id} className="p-4 border-b last:border-b-0">
                <h4 className="font-semibold text-gray-800">{res.title}</h4>
                <p className="text-sm text-gray-600 line-clamp-2">{res.content}</p>
              </li>
            ))}
          </ul>
        ) : (
          <p className="text-gray-500">Belum ada materi yang dibagikan.</p>
        )}
        <button onClick={() => setView('resources')} className="text-blue-600 font-medium text-sm mt-4 hover:underline">Lihat Semua</button>
      </div>
    </div>
  );
}

// --- KOMPONEN DAFTAR KONSELOR ---
function CounselorList({ counselors, onBook }) {
  return (
    <div className="bg-white p-6 rounded-lg shadow-md">
      <h2 className="text-2xl font-bold text-gray-800 mb-6">Daftar Konselor</h2>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {counselors.map(c => (
          <div key={c.id} className="border border-gray-200 rounded-lg p-6 shadow-sm hover:shadow-lg transition-shadow bg-gray-50">
            <h3 className="text-xl font-semibold text-gray-900">{c.name}</h3>
            <p className="text-blue-600 font-medium my-2">{c.specialty}</p>
            <button
              onClick={() => onBook(c)}
              className="w-full mt-4 py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-all duration-300"
            >
              Buat Janji Temu
            </button>
          </div>
        ))}
      </div>
    </div>
  );
}

// --- KOMPONEN MODAL BOOKING ---
function BookingModal({ user, counselor, onClose, userProfile }) {
  const [studentName, setStudentName] = useState(userProfile.name); // Ambil nama dari profil
  const [date, setDate] = useState("");
  const [time, setTime] = useState("");
  const [topic, setTopic] = useState("Akademik");
  const [isSubmitting, setIsSubmitting] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!studentName || !date || !time) {
      alert("Harap isi semua field.");
      return;
    }
    setIsSubmitting(true);

    try {
      const dateTime = new Date(`${date}T${time}`);
      await addDoc(appointmentsCol, {
        studentId: user.uid,
        studentName: studentName,
        counselorId: counselor.userId,
        counselorName: counselor.name,
        dateTime: dateTime.toISOString(),
        topic: topic,
        status: 'pending', // 'pending', 'approved', 'completed'
        createdAt: new Date().toISOString()
      });
      alert("Permintaan janji temu berhasil dikirim!");
      onClose();
    } catch (error) {
      console.error("Gagal membuat janji temu:", error);
      alert("Terjadi kesalahan. Silakan coba lagi.");
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg space-y-6">
        <h2 className="text-2xl font-bold text-gray-800">Buat Janji Temu</h2>
        <p className="text-gray-600">dengan <span className="font-semibold">{counselor.name}</span></p>
        
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap Anda</label>
            <input
              type="text"
              value={studentName}
              onChange={(e) => setStudentName(e.target.value)} // Tetap ada jika user mau ganti
              placeholder="Masukkan nama lengkap Anda"
              className="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-100"
              required
              readOnly // Buat read-only karena sudah diisi otomatis
            />
          </div>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
              <input
                type="date"
                value={date}
                onChange={(e) => setDate(e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                required
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Waktu</label>
              <input
                type="time"
                value={time}
                onChange={(e) => setTime(e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                required
              />
            </div>
          </div>
           <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Topik Konseling</label>
            <select
              value={topic}
              onChange={(e) => setTopic(e.target.value)}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option>Akademik</option>
              <option>Karir</option>
              <option>Keluarga</option>
              <option>Pribadi</option>
              <option>Sosial</option>
            </select>
          </div>
          <div className="flex justify-end space-x-4 pt-4">
            <button
              type="button"
              onClick={onClose}
              disabled={isSubmitting}
              className="py-2 px-4 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200"
            >
              Batal
            </button>
            <button
              type="submit"
              disabled={isSubmitting}
              className="py-2 px-6 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 disabled:bg-gray-400"
            >
              {isSubmitting ? "Mengirim..." : "Kirim Permintaan"}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}

// --- KOMPONEN DAFTAR JANJI TEMU (Umum) ---
function AppointmentList({ title, appointments, onApprove, onComplete }) {
  const getStatusChip = (status) => {
    switch (status) {
      case 'pending':
        return <span className="px-3 py-1 text-xs font-medium text-yellow-800 bg-yellow-100 rounded-full">Menunggu</span>;
      case 'approved':
        return <span className="px-3 py-1 text-xs font-medium text-green-800 bg-green-100 rounded-full">Disetujui</span>;
      case 'completed':
        return <span className="px-3 py-1 text-xs font-medium text-gray-800 bg-gray-200 rounded-full">Selesai</span>;
      default:
        return null;
    }
  };
  
  const sortedAppointments = useMemo(() => {
    return [...appointments].sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime));
  }, [appointments]);

  return (
    <div className="bg-white p-6 rounded-lg shadow-md">
      <h2 className="text-2xl font-bold text-gray-800 mb-6">{title}</h2>
      <div className="space-y-4">
        {sortedAppointments.length > 0 ? (
          sortedAppointments.map(apt => (
            <div key={apt.id} className="border border-gray-200 rounded-lg p-4 shadow-sm bg-gray-50">
              <div className="flex flex-col md:flex-row justify-between md:items-center">
                <div>
                  <p className="text-lg font-semibold text-gray-800">
                    {apt.studentName || apt.counselorName}
                  </p>
                  <p className="text-gray-600">
                    {new Date(apt.dateTime).toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'short' })}
                  </p>
                  <p className="text-sm text-gray-500 mt-1">Topik: {apt.topic}</p>
                </div>
                <div className="flex flex-col items-start md:items-end mt-4 md:mt-0 space-y-2">
                  {getStatusChip(apt.status)}
                  {onApprove && apt.status === 'pending' && (
                    <button
                      onClick={() => onApprove(apt.id)}
                      className="mt-2 py-1 px-4 text-sm bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700"
                    >
                      <Check size={16} className="inline mr-1" /> Setujui
                    </button>
                  )}
                  {onComplete && apt.status === 'approved' && (
                     <button
                      onClick={() => onComplete(apt.id)}
                      className="mt-2 py-1 px-4 text-sm bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700"
                    >
                      Tandai Selesai
                    </button>
                  )}
                </div>
              </div>
            </div>
          ))
        ) : (
          <p className="text-gray-500">Tidak ada data janji temu.</p>
        )}
      </div>
    </div>
  );
}

// --- KOMPONEN DAFTAR MATERI (Umum) ---
function ResourceList({ title, resources }) {
  return (
    <div className="bg-white p-6 rounded-lg shadow-md">
      <h2 className="text-2xl font-bold text-gray-800 mb-6">{title}</h2>
      <div className="space-y-6">
        {resources.length > 0 ? (
          resources.map(res => (
            <div key={res.id} className="border-b border-gray-200 pb-6 last:border-b-0">
              <h3 className="text-xl font-semibold text-gray-800 mb-2">{res.title}</h3>
              <p className="text-gray-600 whitespace-pre-wrap">{res.content}</p>
              <p className="text-xs text-gray-400 mt-4">
                Oleh: {res.counselorName}
              </p>
            </div>
          ))
        ) : (
          <p className="text-gray-500">Belum ada materi yang dibagikan.</p>
        )}
      </div>
    </div>
  );
}

// --- KOMPONEN DASHBOARD KONSELOR ---
function CounselorDashboard({ user, userProfile }) {
  const [view, setView] = useState('requests'); // 'requests', 'schedule', 'resources'
  const [appointments, setAppointments] = useState([]);
  const [resources, setResources] = useState([]);
  // const [counselorProfile, setCounselorProfile] = useState(null); // Dihapus, gunakan userProfile
  
  // Ambil profil konselor (DIHAPUS)
  // useEffect(() => { ... }, [user.uid]);
  
  // Ambil data janji temu untuk konselor ini
  useEffect(() => {
    const q = query(appointmentsCol, where("counselorId", "==", user.uid));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      setAppointments(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
    });
    return () => unsubscribe();
  }, [user.uid]);

  // Ambil data materi
  useEffect(() => {
    const unsubscribe = onSnapshot(resourcesCol, (snapshot) => {
      setResources(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
    });
    return () => unsubscribe();
  }, []);

  const handleApprove = async (id) => {
    const aptRef = doc(db, `${publicPath}/appointments`, id);
    try {
      await updateDoc(aptRef, { status: 'approved' });
    } catch (error) {
      console.error("Gagal menyetujui:", error);
    }
  };
  
  const handleComplete = async (id) => {
    const aptRef = doc(db, `${publicPath}/appointments`, id);
    try {
      await updateDoc(aptRef, { status: 'completed' });
    } catch (error) {
      console.error("Gagal menyelesaikan:", error);
    }
  };

  const handleAddResource = async (title, content) => {
    if (!title || !content || !userProfile) return; // Gunakan userProfile
    try {
      await addDoc(resourcesCol, {
        title,
        content,
        counselorId: user.uid,
        counselorName: userProfile.name, // Gunakan userProfile
        createdAt: new Date().toISOString()
      });
    } catch (error) {
      console.error("Gagal menambah materi:", error);
    }
  };

  const pendingAppointments = appointments.filter(a => a.status === 'pending');
  const upcomingAppointments = appointments.filter(a => a.status === 'approved' && new Date(a.dateTime) > new Date());
  
  const navItems = [
    { key: 'requests', label: 'Permintaan Baru', icon: Clock, count: pendingAppointments.length },
    { key: 'schedule', label: 'Jadwal Saya', icon: Calendar, count: upcomingAppointments.length },
    { key: 'resources', label: 'Kelola Materi', icon: BookOpen },
  ];

  return (
     <div className="flex flex-col md:flex-row gap-8">
      {/* Navigasi Samping */}
      <nav className="md:w-64 bg-white p-4 rounded-lg shadow-md md:sticky top-8 self-start">
        <ul className="space-y-2">
          {navItems.map(item => (
            <li key={item.key}>
              <button
                onClick={() => setView(item.key)}
                className={`flex items-center justify-between w-full space-x-3 p-3 rounded-lg transition-colors ${
                  view === item.key
                    ? 'bg-blue-600 text-white shadow'
                    : 'text-gray-700 hover:bg-gray-100'
                }`}
              >
                <div className="flex items-center space-x-3">
                  <item.icon size={20} />
                  <span className="font-medium">{item.label}</span>
                </div>
                {item.count > 0 && (
                  <span className="text-xs font-bold bg-white text-blue-600 rounded-full px-2 py-0.5">
                    {item.count}
                  </span>
                )}
              </button>
            </li>
          ))}
        </ul>
      </nav>
      
      {/* Konten Utama */}
      <div className="flex-1 space-y-8">
        <h2 className="text-3xl font-bold text-gray-800">Halo, {userProfile?.name || 'Konselor'}!</h2>
        
        {view === 'requests' && (
          <AppointmentList
            title="Permintaan Janji Temu Baru"
            appointments={pendingAppointments}
            onApprove={handleApprove}
          />
        )}
        {view === 'schedule' && (
          <AppointmentList
            title="Jadwal Disetujui & Riwayat"
            appointments={appointments.filter(a => a.status !== 'pending')}
            onComplete={handleComplete}
          />
        )}
        {view === 'resources' && (
          <div className="space-y-8">
            <AddResourceForm onSubmit={handleAddResource} />
            <ResourceList
              title="Materi yang Sudah Dibagikan"
              resources={resources.filter(r => r.counselorId === user.uid)}
            />
          </div>
        )}
      </div>
    </div>
  );
}

// --- KOMPONEN FORM TAMBAH MATERI ---
function AddResourceForm({ onSubmit }) {
  const [title, setTitle] = useState("");
  const [content, setContent] = useState("");

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!title || !content) return;
    onSubmit(title, content);
    setTitle("");
    setContent("");
  };

  return (
    <form onSubmit={handleSubmit} className="bg-white p-6 rounded-lg shadow-md space-y-4">
      <h3 className="text-2xl font-bold text-gray-800">Bagikan Materi Baru</h3>
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">Judul Materi</label>
        <input
          type="text"
          value={title}
          onChange={(e) => setTitle(e.target.value)}
          placeholder="Misal: Cara Mengatasi Cemas Saat Ujian"
          className="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
      </div>
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">Isi Materi / Tautan</label>
        <textarea
          value={content}
          onChange={(e) => setContent(e.target.value)}
          rows="5"
          placeholder="Tuliskan isi materi atau tempel tautan video/artikel di sini..."
          className="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
        ></textarea>
      </div>
      <div className="text-right">
        <button
          type="submit"
          className="py-2 px-6 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700"
        >
          <Plus size={18} className="inline mr-2" /> Bagikan
        </button>
      </div>
    </form>
  );
}

// --- KOMPONEN LAYAR LOADING ---
function LoadingScreen({ text = "Memuat aplikasi..." }) {
  return (
    <div className="flex items-center justify-center min-h-screen bg-gray-100">
      <div className="flex flex-col items-center">
        <svg className="animate-spin h-12 w-12 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
          <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p className="mt-4 text-lg font-medium text-gray-700">{text}</p>
      </div>
    </div>
  );
}


